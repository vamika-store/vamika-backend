name: Vamika-backend

on: 
    workflow_dispatch:
jobs:
    build-image_tag_update:
        runs-on: ubuntu-latest
        env:
            IMAGE_NAME: "kubevamshi/vamika-backend:v0.0.1"
            BUILDER_IMAGE: "${{ secrets.IMAGE_REGISTRY }}/maven:3.9.9-ibm-semeru-17-focal"
        steps:
            - name: Checkout code
              uses: actions/checkout@v2
            - name: Docker Login
              run: |
                echo "${{ secrets.IMAGE_REGISTRY_TOKEN }}" | docker login -u ${{ secrets.IMAGE_REGISTRY_USERNAME }} -- password-stdin
            - name: Docker Build
              run: |
                COMMIT_AUTHOR=$(git log --pretty=%an)
                COMMIT_ID=$(git rev-parse --short "$GITHUB_SHA")
                docker buildx build \
                  --build-arg BUILDER_IMAGE=${{ env.BUILDER_IMAGE }} \
                  --label AUTHOR=${COMMIT_AUTHOR} \
                  --label COMMIT_ID=${COMMIT_ID} \
                  -t ${{ secrets.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }} .
            - name: Push Docker image
              run: |
                docker push ${{ secrets.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}
            - name: Docker Logout
              run: |
                docker logout ${{ secrets.IMAGE_REGISTRY }}